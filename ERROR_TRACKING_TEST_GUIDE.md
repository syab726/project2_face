# 🧪 오류 추적 시스템 테스트 가이드

## 📋 테스트 개요

이 문서는 구현된 실제 오류 추적 시스템이 올바르게 작동하는지 검증하는 방법을 설명합니다.

### 🎯 테스트 목표
- 사용자 오류 발생 시 Admin 대시보드에 실시간 반영 확인
- 주문-서비스 이용 흐름 추적 검증
- 환불 처리 로직 및 오류 이력 확인 시스템 검증

## 🚀 테스트 실행 방법

### 1. 기본 준비

```bash
# 1. 개발 서버 실행
npm run dev

# 2. 브라우저에서 http://localhost:3000 접속
```

### 2. 자동 테스트 도구 사용

#### A. 테스트 패널 접속
1. 메인 페이지 하단의 **"🧪 테스트"** 버튼 클릭
2. 오류 추적 시스템 테스트 패널 열기

#### B. 오류 시뮬레이션 실행
1. **오류 타입 선택**: 다음 중 하나 선택
   - 🤖 AI 분석 타임아웃
   - 💳 결제 실패
   - 🖼️ 이미지 처리 오류
   - ⚡ 시스템 과부하
   - 💾 DB 연결 오류
   - ✅ 입력 검증 오류

2. **"💥 오류 발생시키기"** 버튼 클릭

3. **Admin 대시보드 확인**:
   - "📊 Admin 대시보드 확인" 버튼 클릭
   - 새 탭에서 `/admin` 열림
   - 비밀번호: `admin123!@#` 입력

### 3. 수동 실제 오류 테스트

#### A. 실제 API 호출로 오류 발생
```bash
# 잘못된 데이터로 API 호출
curl -X POST http://localhost:3000/api/analysis/mbti-face \
  -F "mbtiType=INVALID" \
  -F "age=abc" \
  -F "userEmail=test@example.com" \
  -F "orderId=MANUAL-TEST-001"
```

#### B. 파일 크기 초과 테스트
1. 관상 분석 페이지에서 10MB 이상 이미지 업로드
2. 오류 발생 확인 후 Admin 대시보드에서 로그 확인

## 🔍 검증 체크리스트

### ✅ 실시간 오류 추적 검증

- [ ] **테스트 오류 발생 후 즉시 Admin 대시보드 "서비스 오류" 탭에 표시**
- [ ] **오류 정보 완전성**: 제목, 메시지, 사용자 이메일, 주문 ID, 타임스탬프
- [ ] **오류 타입별 분류**: ai_error, payment_error, system_error, timeout_error
- [ ] **메타데이터 포함**: API 엔드포인트, 에러 스택, 추가 컨텍스트

### ✅ 주문-서비스 흐름 추적 검증

- [ ] **주문 생성**: API 호출 시 orderService에 주문 자동 생성
- [ ] **상태 추적**: in_progress → completed/failed 상태 변화
- [ ] **가격 정확성**: 
  - MBTI × 관상: 4,900원
  - 전문 관상: 9,900원
  - 관상 + 사주: 19,900원
- [ ] **오류 로그 자동 기록**: 실패 시 주문에 오류 내역 저장

### ✅ Admin 대시보드 실시간 반영

- [ ] **통계 업데이트**: 활성 오류 수 실시간 증가
- [ ] **그래프 반영**: "통계 및 그래프" 탭에서 오류 증가 확인
- [ ] **최근 오류 목록**: 발생 시간순 정렬로 최신 오류 상단 표시
- [ ] **오류 상태 관리**: new → investigating → resolved 변경 가능

### ✅ 환불 처리 시스템 검증

#### 환불 요청 테스트
```bash
# 환불 요청 API 테스트
curl -X POST http://localhost:3000/api/admin/refund \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "TEST-ORDER-123",
    "reason": "서비스 분석 실패",
    "adminNotes": "AI 타임아웃으로 인한 분석 실패",
    "sessionId": "YOUR_ADMIN_SESSION_ID"
  }'
```

- [ ] **오류 이력 확인**: `hasServiceErrors()` 메서드로 환불 근거 검증
- [ ] **환불 처리 완료**: `processRefund()` 메서드 실행 후 상태 변경
- [ ] **환불 요청 목록**: Admin 대시보드에서 환불 요청 조회 가능

## 🐛 예상 시나리오별 테스트

### 시나리오 1: 사용자 불만 접수
```
1. 사용자: "MBTI 분석이 안 돼요!"
2. 관리자: 주문 ID 확인 → Admin 대시보드에서 오류 이력 조회
3. 오류 발견 시: 즉시 환불 처리
4. 오류 없음 시: "서비스 이용 성공 이력 확인됨" 응답
```

### 시나리오 2: 시스템 모니터링
```
1. Admin 대시보드 "통계 및 그래프" 확인
2. 활성 오류 수 급증 감지
3. "서비스 오류" 탭에서 오류 패턴 분석
4. 근본 원인 파악 후 해결 조치
```

### 시나리오 3: 정기 오류 리뷰
```
1. 주간/월간 오류 통계 확인
2. 반복되는 오류 패턴 식별
3. 시스템 개선 계획 수립
4. 해결된 오류는 'resolved' 상태로 변경
```

## 🚨 알려진 제한사항

### 현재 구현 상태
- ✅ **실시간 오류 추적**: 완전 구현
- ✅ **주문 흐름 관리**: 완전 구현
- ✅ **환불 처리**: API 구현 완료
- ⚠️ **실제 결제 연동**: 현재 Mock 상태
- ⚠️ **이메일 알림**: 콘솔 로그로 대체

### 메모리 기반 저장소
- 서버 재시작 시 데이터 초기화
- 실제 운영 시 데이터베이스 연동 필요

## ⚡ 문제 해결

### 테스트 실패 시 확인사항

1. **서버 실행 상태**: `npm run dev` 정상 실행 여부
2. **브라우저 콘솔**: JavaScript 오류 확인
3. **네트워크 탭**: API 호출 상태 확인
4. **Admin 세션**: 로그인 상태 유지 확인

### 자주 발생하는 문제

#### "세션이 만료되었습니다" 오류
```javascript
// 해결: Admin 대시보드에서 다시 로그인
// 비밀번호: admin123!@#
```

#### 테스트 데이터 정리
```bash
# 서버 재시작으로 메모리 데이터 초기화
npm run dev
```

## 📊 성공 기준

### 완전 성공 (모든 항목 ✅)
- 오류 발생 → Admin 대시보드 즉시 반영 (5초 이내)
- 주문 상태 정확한 추적 (생성 → 진행 → 완료/실패)
- 환불 처리 로직 정상 작동
- 통계 그래프 실시간 업데이트

### 부분 성공 (일부 지연 또는 누락)
- 오류 반영 지연 (5-30초)
- 통계 데이터 불일치
- 일부 메타데이터 누락

### 실패 (즉시 수정 필요)
- 오류 발생해도 Admin 대시보드에 표시 안됨
- 주문 생성 실패
- API 오류로 테스트 불가능

---

💡 **테스트 완료 후 피드백**: 발견된 문제점이나 개선사항을 이슈로 등록해주세요!