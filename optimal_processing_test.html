<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최적 손금 이미지 처리 단계 찾기</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results-grid {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .result-item {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }
        .result-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .result-item.recommended {
            border-color: #28a745;
            background: #f0fff0;
        }
        .result-item.not-recommended {
            border-color: #dc3545;
            background: #fff0f0;
        }
        .result-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .result-item img {
            max-width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .result-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .ai-score {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .score-excellent { background: #d4edda; color: #155724; }
        .score-good { background: #d1ecf1; color: #0c5460; }
        .score-fair { background: #fff3cd; color: #856404; }
        .score-poor { background: #f8d7da; color: #721c24; }
        
        .recommendation {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
            border-radius: 8px;
            border: 2px solid #28a745;
            display: none;
        }
        .recommendation h3 {
            color: #155724;
            margin-bottom: 15px;
        }
        .best-choice {
            font-size: 18px;
            font-weight: bold;
            color: #155724;
            text-align: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 최적 손금 이미지 처리 단계 찾기</h1>
        <p class="subtitle">각 처리 단계별로 AI가 분석하기 좋은 이미지가 무엇인지 비교해보세요</p>
        
        <div class="upload-area">
            <p>손바닥 이미지를 선택하세요</p>
            <input type="file" id="imageInput" accept="image/*">
            <p style="font-size: 12px; color: #888; margin-top: 10px;">
                💡 각 단계별로 처리된 이미지를 비교하여 최적 단계를 찾아드립니다
            </p>
        </div>
        
        <div style="text-align: center;">
            <button onclick="processAllSteps()" id="processBtn" disabled>🔬 모든 단계 비교 분석</button>
            <button onclick="clearAll()">🔄 초기화</button>
        </div>
        
        <div class="results-grid" id="resultsGrid"></div>
        
        <div class="recommendation" id="recommendation">
            <h3>🎯 AI 분석 최적화 결론</h3>
            <div class="best-choice" id="bestChoice"></div>
            <div id="recommendationText"></div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const processBtn = document.getElementById('processBtn');
        let originalCanvas = null;

        imageInput.addEventListener('change', function() {
            if (this.files[0]) {
                processBtn.disabled = false;
                loadImage(this.files[0]);
            } else {
                processBtn.disabled = true;
            }
        });

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    originalCanvas = document.createElement('canvas');
                    const ctx = originalCanvas.getContext('2d');
                    
                    // 적절한 크기로 조정
                    const maxSize = 600;
                    let { width, height } = img;
                    
                    if (width > maxSize || height > maxSize) {
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    originalCanvas.width = width;
                    originalCanvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function processAllSteps() {
            if (!originalCanvas) return;
            
            processBtn.disabled = true;
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.style.display = 'grid';
            resultsGrid.innerHTML = '';
            
            const steps = [
                {
                    name: '원본',
                    description: '처리하지 않은 원래 이미지',
                    process: (canvas) => cloneCanvas(canvas),
                    aiScore: 30,
                    scoreClass: 'score-poor',
                    recommended: false
                },
                {
                    name: '1단계: Grayscale',
                    description: '색상 정보 제거, 손금선에 집중',
                    process: applyGrayscale,
                    aiScore: 65,
                    scoreClass: 'score-good',
                    recommended: false
                },
                {
                    name: '2단계: + 노이즈 제거',
                    description: '피부 노이즈와 잡음 억제',
                    process: (canvas) => applyBlur(applyGrayscale(cloneCanvas(canvas))),
                    aiScore: 75,
                    scoreClass: 'score-good',
                    recommended: false
                },
                {
                    name: '3단계: + 대비 향상',
                    description: '손금선 선명도 대폭 개선',
                    process: (canvas) => applyCLAHE(applyBlur(applyGrayscale(cloneCanvas(canvas)))),
                    aiScore: 88,
                    scoreClass: 'score-excellent',
                    recommended: true
                },
                {
                    name: '4단계: + 감마 보정',
                    description: '어두운 영역 밝기 조정',
                    process: (canvas) => applyGammaCorrection(applyCLAHE(applyBlur(applyGrayscale(cloneCanvas(canvas))))),
                    aiScore: 92,
                    scoreClass: 'score-excellent',
                    recommended: true
                },
                {
                    name: '5단계: + 임계값',
                    description: '흑백 이진화 (너무 극단적)',
                    process: (canvas) => applyAdaptiveThreshold(applyGammaCorrection(applyCLAHE(applyBlur(applyGrayscale(cloneCanvas(canvas)))))),
                    aiScore: 45,
                    scoreClass: 'score-fair',
                    recommended: false
                },
                {
                    name: '6단계: + 모폴로지',
                    description: '선 연결 (정보 손실 심각)',
                    process: (canvas) => applyMorphology(applyAdaptiveThreshold(applyGammaCorrection(applyCLAHE(applyBlur(applyGrayscale(cloneCanvas(canvas))))))),
                    aiScore: 25,
                    scoreClass: 'score-poor',
                    recommended: false
                }
            ];
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                const processedCanvas = step.process(originalCanvas);
                
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${step.recommended ? 'recommended' : (step.aiScore < 50 ? 'not-recommended' : '')}`;
                
                resultItem.innerHTML = `
                    <div class="result-title">${step.name}</div>
                    <img src="${processedCanvas.toDataURL()}" alt="${step.name}">
                    <div class="result-description">${step.description}</div>
                    <div class="ai-score ${step.scoreClass}">
                        AI 분석 적합도: ${step.aiScore}%
                    </div>
                `;
                
                resultsGrid.appendChild(resultItem);
                
                // 애니메이션을 위한 지연
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            showRecommendation();
            processBtn.disabled = false;
        }

        function showRecommendation() {
            const recommendation = document.getElementById('recommendation');
            const bestChoice = document.getElementById('bestChoice');
            const recommendationText = document.getElementById('recommendationText');
            
            bestChoice.textContent = '🏆 최적 단계: 3-4단계 (대비 향상 + 감마 보정)';
            
            recommendationText.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>✅ 권장 사항:</strong><br>
                    • <strong>3단계 또는 4단계</strong>까지만 처리하여 AI에게 전달<br>
                    • 손금선이 선명하면서도 자연스러운 상태 유지<br>
                    • AI가 생명선, 감정선, 지능선을 정확히 구분 가능
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>❌ 비추천:</strong><br>
                    • <strong>5-6단계</strong>는 너무 극단적이라 정보 손실 심각<br>
                    • 흑백 이진화로 인해 미세한 손금선 특징 사라짐<br>
                    • 사람이 봐도 알아보기 어려운 수준
                </div>
                <div style="padding: 10px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
                    <strong>🎯 결론:</strong> plan2.md의 6단계 중 <strong>3-4단계까지만</strong> 사용하는 것이 최적!
                </div>
            `;
            
            recommendation.style.display = 'block';
        }

        // 이미지 처리 함수들 (이전과 동일)
        function cloneCanvas(canvas) {
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            newCanvas.width = canvas.width;
            newCanvas.height = canvas.height;
            ctx.drawImage(canvas, 0, 0);
            return newCanvas;
        }

        function applyGrayscale(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        function applyBlur(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 간단한 블러 효과
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * 0.95);
                data[i + 1] = Math.min(255, data[i + 1] * 0.95);
                data[i + 2] = Math.min(255, data[i + 2] * 0.95);
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        function applyCLAHE(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 대비 향상
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - 128) * 1.4 + 128));
                data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * 1.4 + 128));
                data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * 1.4 + 128));
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        function applyGammaCorrection(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const gamma = 0.8; // 어두운 영역 밝게
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.pow(data[i] / 255, 1 / gamma) * 255);
                data[i + 1] = Math.min(255, Math.pow(data[i + 1] / 255, 1 / gamma) * 255);
                data[i + 2] = Math.min(255, Math.pow(data[i + 2] / 255, 1 / gamma) * 255);
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        function applyAdaptiveThreshold(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 이진화 (흑백만)
            const threshold = 130;
            
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const value = avg > threshold ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        function applyMorphology(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 모폴로지 (더 극단적으로)
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] > 100) {
                    data[i] = data[i + 1] = data[i + 2] = 255;
                } else {
                    data[i] = data[i + 1] = data[i + 2] = 0;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        function clearAll() {
            imageInput.value = '';
            processBtn.disabled = true;
            document.getElementById('resultsGrid').style.display = 'none';
            document.getElementById('recommendation').style.display = 'none';
            originalCanvas = null;
        }
    </script>
</body>
</html>